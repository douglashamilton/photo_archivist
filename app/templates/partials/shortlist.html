{% set is_polling = scan_state in ["queued", "running"] %}
<section
  id="shortlist"
  aria-live="polite"
  data-scan-state="{{ scan_state }}"
  {% if scan_id %}data-scan-id="{{ scan_id }}"{% endif %}
  {% if is_polling and scan_id %}
    hx-get="/fragments/shortlist/{{ scan_id }}"
    hx-trigger="load, every 1s"
    hx-target="#shortlist"
    hx-swap="outerHTML"
  {% endif %}
>
  {% if errors %}
    <div class="error" role="alert">
      <h2>Scan request issue</h2>
      <ul>
        {% for error in errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% elif is_polling %}
    <header>
      <h2>Scan in progress</h2>
      <p>
        Processed
        {{ progress.processed }}
        of
        {{ progress.total }}
        JPEG files ({{ progress.matched }} matched so far).
      </p>
    </header>
    <progress value="{{ progress.processed }}" max="{{ progress.total if progress.total else 1 }}">
      {{ progress.processed }} / {{ progress.total }}
    </progress>
  {% elif scan_state == "error" %}
    <div class="error" role="alert">
      <h2>Scan failed</h2>
      <p>{{ status_message or "An unexpected error occurred while scanning." }}</p>
    </div>
  {% elif results %}
    <header>
      <h2>Top {{ results|length }} photos</h2>
      <p>
        Matched {{ summary.matched }} of {{ summary.total }} JPEG files.
        {% if summary.discarded %}Filtered out {{ summary.discarded }} for quality or duplication.{% endif %}
      </p>
    </header>
    <ol>
      {% for photo in results %}
        <li>
          <article class="result{% if photo.selected %} selected{% endif %}">
            {% if scan_id and photo.thumbnail_path %}
              <img
                src="/api/thumbnails/{{ scan_id }}/{{ photo.id }}"
                alt="Thumbnail preview of {{ photo.filename }}"
                loading="lazy"
                width="192"
                height="192"
              />
            {% elif scan_id %}
              <p class="thumbnail-fallback">Thumbnail unavailable.</p>
            {% endif %}
            <header>
              <h3>{{ photo.filename }}</h3>
            </header>
            <p>
              Captured
              {{ photo.captured_at.strftime("%Y-%m-%d %H:%M:%S") }}
              {% if photo.used_fallback %}(file modified time fallback){% endif %}
            </p>
            {% set brightness_score = photo.metrics.get("brightness", photo.brightness) if photo.metrics else photo.brightness %}
            {% set contrast_score = photo.metrics.get("contrast", 0.0) if photo.metrics else 0.0 %}
            {% set sharpness_score = photo.metrics.get("sharpness", 0.0) if photo.metrics else 0.0 %}
            {% set aesthetic_score = photo.metrics.get("aesthetic", 0.0) if photo.metrics else 0.0 %}
            <p>
              Quality: {{ photo.quality_status|capitalize }}{% if photo.quality_notes %} ({{ photo.quality_notes|join(", ") }}){% endif %}
            </p>
            <ul>
              <li>Aesthetic: {{ "%.2f"|format(aesthetic_score) }}</li>
              <li>Sharpness (Laplacian var): {{ "%.1f"|format(sharpness_score) }}{% if photo.quality_status == "soft" %} — soft{% endif %}</li>
              <li>Brightness: {{ "%.1f"|format(brightness_score) }}</li>
              <li>Contrast: {{ "%.1f"|format(contrast_score) }}</li>
              {% if photo.metrics and photo.metrics.get("width") and photo.metrics.get("height") %}
                <li>Resolution: {{ photo.metrics["width"]|int }}×{{ photo.metrics["height"]|int }} (aspect {{ "%.2f"|format(photo.metrics.get("aspect_ratio", 0.0)) }})</li>
              {% endif %}
              {% if photo.cluster_id %}
                <li>Burst: {{ photo.cluster_id }} (rank {{ photo.cluster_rank }} of {{ photo.cluster_size }})</li>
              {% endif %}
            </ul>
            <div class="controls">
              {% if photo.selected %}
                <span class="selection-status">Selected</span>
              {% endif %}
              <form
                action="/api/scans/{{ scan_id }}/photos/{{ photo.id }}/selection"
                method="post"
                hx-post="/api/scans/{{ scan_id }}/photos/{{ photo.id }}/selection"
                hx-target="#shortlist"
                hx-swap="outerHTML"
              >
                <input type="hidden" name="selected" value="{{ "false" if photo.selected else "true" }}" />
                <button
                  type="submit"
                  class="{% if photo.selected %}secondary{% else %}primary{% endif %}"
                  aria-pressed="{{ 'true' if photo.selected else 'false' }}"
                >
                  {% if photo.selected %}Deselect{% else %}Select{% endif %}
                </button>
              </form>
            </div>
          </article>
        </li>
      {% endfor %}
    </ol>
  {% elif scan_attempted %}
    <p>No photos survived the selected date range and quality filters.{% if summary.discarded %} {{ summary.discarded }} images were discarded for being dark, soft, or near-duplicates.{% endif %}</p>
  {% else %}
    <p>No scan requested yet.</p>
  {% endif %}
</section>
